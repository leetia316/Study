# MASM(8086 CUP)汇编

- CPU执行的`指令`从 CS(段地址寄存器) IP(偏移地址寄存器) 所组合的地址中来
- 指令和数据在内存中是没有区别的
- 数据从哪里来
  - 寄存器中
  - 内存中
- 数据长度
  - 字节型数据（8位）
  - 字型数据（16位）

## 汇编语言组成

- 汇编指令
  - 被编译器翻译成 机器指令-机器码 又 CUP 执行
- 伪指令
  - 由编译器执行
- 符号体系
  - 由编译器执行

## 寄存器

### 数据寄存器

- AX = AH + AL
- BX = BH + BL    也可以被当作偏移地址寄存器
- CX = CH + CL    有其它作用
- DX = DH + DL

### 地址寄存器

#### 段地址寄存器

> 16位寄存器，可各自分割为2个相互独立的8位寄存器

- DS
  - 一般用来访问数据
- ES
- SS
- CS

#### 偏移地址寄存器

### 标志位寄存器

## DEBUG

- d: 查看内存
- u: 将内存中的机器指令翻译成汇编指令展示
- r: 查看寄存器/修改寄存器
- t: 执行当前(CS:IP)命令
- a: 输入汇编指令
- e: 修改内存内容
- p: 执行 `int` 指令

## 指令

### 指令执行过程

- CUP从 当前的 CS 和 IP 指向的内存单元读取指令，然后将读取的指令存入指令缓冲器
- IP = IP + 所读指令的字节数，从而指向下一条指令
- 执行指令缓冲器中的内容， 回到第一步

### 转移指令(jmp)

> 改变 CS IP 寄存器的 汇编指令

```assembly
jmp 2AE3:0003 ; CS = 2AE3H , IP = 0003H
jmp 0003 ; IP = 0003H
```

### 移动指令(mov)

> 将数据从一个地方移动到另一个内存中

```assembly
mov ax, 1000 ; 将 1000H 存入 ax 寄存器中， ax = 1000H
```

### 减法指令(sub)

```assembly
sub ax, ax ; ax = ax - ax
```

### 栈操作指令

```assembly
push ax ; 将 ax寄存器 中的数据存入栈中
```

```assembly
pop bx ; 将栈顶数据取出存入 bx寄存器 中
```

## 栈（字型数据操作）

> 栈是一段连续的内存单元，也就是一段连续的内存地址，具有特定的访问方式（先进后出），从高地址到低地址

> `8086CUP`中将 段地址寄存器 SS 和偏移地址寄存器SP 所组合出来的内存地址当作栈顶标记

- 栈顶标记：标记了最后进栈数据的位置
- 入栈（push）：将数据放入栈顶标记的上方
- 出栈（pop）：将数据从栈顶取出放到十六位寄存器或内存中

### 作用

- 临时性保存数据

## 内存段安全

> 随意向某一段内存空间中写入内容是很危险的

- 安全的内存空间（0:200 ～ 0:2FF) 256个字节
- 操作系统分配的内存空间
  - 程序加载时系统分配的内存空间
  - 程序在执行过程中向系统申请的内存空间

### 系统如何分配内存

- exe文件中除了整个程序还包括了一些信息
  - 文件有多大
  - 程序在哪里
- 系统根据描述信息对寄存器进行相关设置
- `start`伪指令告诉系统程序的起始位置，系统通过`start`的信息设置 CS、IP
- 开始的 256 个字节时 PSP 区 用于程序与系统的通信

## 归纳

1. 获取操作指令（CS+IP所指内存数据代表操作）
2. 获取操作数据
   1. 从普通内存中（DS+[指定偏移地址0000]）
   2. 从栈内存中（SS+SP）