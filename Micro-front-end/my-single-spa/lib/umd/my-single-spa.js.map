{"version":3,"file":"my-single-spa.js","sources":["../../src/applications/apps.helper.js","../../src/start.js","../../src/lifecycles/helper.js","../../src/lifecycles/load.js","../../src/navigation/invoke.js","../../src/applications/apps.js"],"sourcesContent":["export const NOT_LOADED = {\n  status: 'NOT_LOADED',\n}\n\nexport const SKIP_BECAUSE_BROKEN = {\n  status: 'SKIP_BECAUSE_BROKEN',\n}\n\nexport const LOAD_ERROR = {\n  status: 'LOAD_ERROR',\n}\n\nexport const LOAD_SOURCE_CODE = {\n  status: 'LOAD_SOURCE_CODE',\n}\n\nexport function noSkip(app) {\n  return app.status !== SKIP_BECAUSE_BROKEN;\n}\n\nexport function noLoadError(app) {\n  return app.status !== LOAD_ERROR;\n}\n\nexport function isntLoaded(app) {\n  return app.status === NOT_LOADED;\n}\n\nexport function shouldBeActive(app) {\n  try {\n    return app.activityWhen(window.location);\n  } catch (e) {\n    app.status = SKIP_BECAUSE_BROKEN;\n    console.log(e);\n  }\n}\n","let started = false;\n\nexport function start() {\n  \n}\n\nexport function isStarted() {\n  return started;\n}","export function smellLikePromise(promise) {\n  if (promise instanceof Promise) {\n    return true;\n  }\n  return (typeof promise === 'object' &&\n    typeof promise.then === 'function' &&\n    typeof promise.catch === 'function');\n}\n\nexport function flattenLifecyclesArray(lifecycle, description) {\n  if (!Array.isArray(lifecycle)) {\n    lifecycle = [lifecycle];\n  }\n  if (!lifecycle.length) {\n    lifecycle = [() => Promise.resolve()];\n  }\n\n  return new Promise((resolve, reject) => {\n    function waitForPromises(index) {\n      let fn = lifecycle[index]();\n      if (!smellLikePromise(fn)) {\n        reject(new Error(`${description} has error`));\n      } else {\n        fn.then(() => {\n          if (index >= lifecycle.length - 1) {\n            resolve();\n          } else {\n            waitForPromises(++index);\n          }\n        }).catch(reject);\n      }\n    }\n    waitForPromises(0);\n  })\n}","import {\n  NOT_LOADED,\n  LOAD_SOURCE_CODE, SKIP_BECAUSE_BROKEN\n} from '../applications/apps.helper';\nimport {\n  smellLikePromise,\n  flattenLifecyclesArray,\n} from './helper';\n\nexport function toLoadPromise(app) {\n  if (app.status !== NOT_LOADED) {\n    return Promise.resolve(app);\n  }\n  app.status = LOAD_SOURCE_CODE;\n\n  let loadPromise = app.loadFunction();\n\n  if (!smellLikePromise(loadPromise)) {\n    return Promise.reject(new Error(''));\n  }\n  loadPromise.then(appConfig => {\n    if (typeof appConfig !== 'object') {\n      throw new Error('');\n    }\n    let errors = [];\n    [\n      'bootstrap',\n      'mount',\n      'unmount',\n    ].forEach(lifecycle => {\n      if (!appConfig[lifecycle]) {\n        errors.push(`lifecycle: ${lifecycle} must be exists`);\n      }\n    });\n\n    if (errors.length) {\n      app.status = SKIP_BECAUSE_BROKEN;\n      console.log(errors);\n      return;\n    }\n\n    app.bootstrap = flattenLifecyclesArray(appConfig.bootstrap, `app: ${app.name} bootstrapping`);\n    app.mount = flattenLifecyclesArray(appConfig.mount, `app: ${app.name} mounting`);\n    app.unmount = flattenLifecyclesArray(appConfig.unmount, `app: ${app.name} unmounting`);\n\n  })\n}","import {isStarted} from '../start';\nimport {getAppsToLoad} from '../applications/apps';\nimport {toLoadPromise} from '../lifecycles/load.js';\n\nlet appChangesUnderway = false;\nlet changesQueue = [];\n\nexport function invoke() {\n  if (appChangesUnderway) {\n    return new Promise((resolve, reject) => {\n      changesQueue.push({\n        success: resolve,\n        failure: reject,\n      });\n    });\n  }\n  appChangesUnderway = true;\n  if (isStarted()) {\n\n  } else {\n    loadApps();\n  }\n\n  function loadApps() {\n    // 获取需要被load的app\n    getAppsToLoad().map(toLoadPromise);\n  }\n}","import {\n  NOT_LOADED,\n  noSkip,\n  noLoadError,\n  isntLoaded,\n  shouldBeActive,\n} from './apps.helper';\nimport { invoke } from '../navigation/invoke.js';\n// import {filterWith} from '../utils/optimize-function.js';\n\nconst APPS = [];\n\n/**\n * 注册app\n * @param {string} appName - 要注册的app的名称\n * @param {Function<Promise> | Object} loadFunction - app异步加载函数或app内容\n * @param {Function<boolean>} activityWhen - 判断该app应该在何时被启动\n * @param {Object} customProps - 自定义配置\n * @returns {Promise}\n */\nexport function registerApplication(appName, loadFunction, activityWhen, customProps) {\n  if (!appName || typeof appName !== 'string') {\n    throw new Error('appName must be a non-empty string');\n  }\n  if (!loadFunction) {\n    throw new Error('loadFunction must bu a function or object');\n  }\n  if (typeof loadFunction !== 'function') {\n    loadFunction = () => Promise.resolve(loadFunction);\n  }\n  if (typeof activityWhen !== 'function') {\n    throw new Error('activityWhen must be a function');\n  }\n\n  APPS.push({\n    name: appName,\n    loadFunction,\n    activityWhen,\n    customProps,\n    status: NOT_LOADED,\n  });\n  console.log(\"registerApplication -> APPS\", APPS);\n  invoke();\n}\n\nexport function getAppsToLoad() {\n  try {\n    console.time('filter');\n    return APPS.filter(noSkip).filter(noLoadError).filter(isntLoaded).filter(shouldBeActive);\n    // return filterWith(APPS, noSkip, noLoadError, isntLoaded, shouldBeActive);\n  } finally {\n    console.timeEnd('filter');\n  }\n}"],"names":["NOT_LOADED","status","SKIP_BECAUSE_BROKEN","LOAD_ERROR","LOAD_SOURCE_CODE","noSkip","app","noLoadError","isntLoaded","shouldBeActive","activityWhen","window","location","e","console","log","start","smellLikePromise","promise","Promise","then","catch","flattenLifecyclesArray","lifecycle","description","Array","isArray","length","resolve","reject","waitForPromises","index","fn","Error","toLoadPromise","loadPromise","loadFunction","appConfig","errors","forEach","push","bootstrap","name","mount","unmount","appChangesUnderway","invoke","loadApps","getAppsToLoad","map","APPS","registerApplication","appName","customProps","time","filter","timeEnd"],"mappings":"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"}